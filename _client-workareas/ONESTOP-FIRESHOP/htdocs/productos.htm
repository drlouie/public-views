#!/usr/bin/perl5 -s

print "Content-type: text/html\n\n";

require "parse_query.nsp";

## connect to DB
use DBI; 
my $dbh = DBI->connect('DBI:mysql:OneStop','root','62Ak.fi1HdBxI') or die "Unable to connect to database: <b>unvWeb</b>\n"; 
$dbh->{RaiseError} = 1; 


	## GET PRODUCT NAMES FOR MENU
	$sth = $dbh->prepare("SELECT * FROM Products");
	$sth->execute or die "Unable to execute query\n"; 
	my @row;
	while(@row = $sth->fetchrow_array) { 
		$PartNum = $row[1];
		$ItemName = $row[5];
		push(@todosProductos,"$PartNum-----$ItemName");
	}
	$sth->finish;

	
	
	##MAKE MENU JS
	$TotalMainMenuCount=0;
	$SubMenuArray="";


	$sth = $dbh->prepare("SELECT * FROM Cataloger ORDER BY MCatID");
	$sth->execute or die "Unable to execute query\n"; 
	my @row;
	while(@row = $sth->fetchrow_array) { 
		$TotalMainMenuCount++;
		$ThyCatID = $row[0];
		$ThyCatConfig = $row[2];
		
		$ThyCatID =~ s/000000000//g;
		$ThyCatID =~ s/00000000//g;
		$ThyCatID =~ s/0000000//g;

		##offset positive start
		$ThyCatID--; 

			$countDSub=0;
			## if multiple children present
			if ($ThyCatConfig =~ "-----") {
				@tSplitConfig = split(/-----/,$ThyCatConfig);
				foreach $unSC (@tSplitConfig) {
					if ($unSC ne "" && $unSC ne "NULL" && $unSC =~ ":::::") {
						$countDSub++;
					}
				}
## 				some errors this way rework above
##				$countDSub = @tSplitConfig;
			}



		if ($TotalMainMenuCount eq "1") {
			$SubMenuArray = $countDSub;
		}	
		else {
			$SubMenuArray = $SubMenuArray . "," . $countDSub;
		}
	}
	$sth->finish;




	


##END LEFT MENUS

$muaMenuScript = `cat js/MyMenu.js`;
$muaMenuScript =~ s/%%TotalMainMenuCount%%/$TotalMainMenuCount/g;
$muaMenuScript =~ s/%%SubMenuArray%%/$SubMenuArray/g;


print qq~

<html>
<head>
<title>One Stop Fire Shop - Fire, EMT & Rescue Equipment, Tools & Gear</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<style type="text/css">
body { background-image: url(images/menuLiner.gif); background-repeat: repeat-y; background-position: left top; scrollbar-face-color:#ECE9E9; scrollbar-highlight-color:#999999; scrollbar-shadow-color:#ECE9E9; scrollbar-3dlight-color: #999999; scrollbar-arrow-color:#000000; scrollbar-track-color:#999999; scrollbar-darkshadow-color:#000000; }
.menuTable { margin-top:25px; border-left:#8C8C8C 1px solid; border-top:#8C8C8C 1px solid; border-bottom:#8C8C8C 1px solid; border-right:#8C8C8C 1px solid; }
.menuText { margin-left:8px; font-size:11px;font-family:verdana,arial,helvetica;color:#000000;line-height:14px; }
.movieText1 { font-size:10px;font-family:verdana,arial,helvetica;color:#000000;line-height:14px; }
.movieText2 { font-size:9px;font-family:verdana,arial,helvetica;color:#000000;line-height:14px;text-decoration:none; }
.movieTitle { font-size:14px;font-family:verdana,arial,helvetica;color:#000000;line-height:14px;text-decoration:none;font-weight:bold; }
.mainText { font-size:11px;font-family:verdana,arial,helvetica;color:#969B61;line-height:16px; }
.tableBacker {  background-image:   url(images/home_middle.jpg); background-repeat: no-repeat; background-position: left top;}

#divFoldCont {position:absolute; left:-25px; top:275px; width:300px; visibility:hidden; text-align:left;}
.clFold {position:absolute; width:300px; }
.clFoldSub {position:absolute; left:45px; width:300px; visibility:hidden;}
.clFoldSub2 {position:absolute; left:15px; width:300px; visibility:hidden;}
.clFoldLinks { font-family:Verdana, Arial, Helvetica, Helv; font-size:10px; font-weight:bold; text-decoration:none; color:black;}
.clSubLinks {font-family:Verdana, Arial, Helvetica, Helv; font-size:9px; font-weight:bold; text-decoration:none; color:black;}
.clSubLinks2 {font-family:Verdana, Arial, Helvetica, Helv; font-size:9px; text-decoration:none; color:black;}  

.bottomDasher { background-image: url(images/bottomDasher.gif); background-repeat: repeat-x; background-position: left top; }

.prodTitle { background-image: url(images/prod_title_back.jpg); background-repeat: no-repeat; background-position: left top; }
.productTitleText { font-size:16px; margin-top:3px; font-family:arial,verdana,helvetica;color:#000000;line-height:14px;text-decoration:none; }
.productDesc { font-size:12px; font-family:verdana,arial,helvetica;color:#000000;line-height:14px;text-decoration:none; }
.productInfo { font-size:10px; font-family:verdana,arial,helvetica;color:#000000;line-height:14px;text-decoration:none; }

 .OSFSInput { background-color: #FFFFFF; border: 1px solid #000000; color:#000000; height:18px; font-size: 9px; font-family:verdana,arial,helvetica; text-align:center; }
 .OSFSSelect { background-color: #FFFFFF; border: 1px solid #000000; color:#000000; height:18px; font-size: 9px; font-family:verdana,arial,helvetica; }
</style>

<script language="JavaScript" type="text/javascript">
$muaMenuScript
</script>
</head>

<body bgcolor="#FFFFFF" LEFTMARGIN="0" TOPMARGIN="0" MARGINWIDTH="0" MARGINHEIGHT="0">

<div id="divFoldCont">
~;

##START LEFT MENUS
	$DivCloser=0;

	$sth = $dbh->prepare("SELECT * FROM Cataloger ORDER BY MCatID");
	$sth->execute or die "Unable to execute query\n"; 
	my @row;
	while(@row = $sth->fetchrow_array) { 
		$CatID = $row[0];
		$CatName = $row[1];
		$CatConfig = $row[2];

		$CatID =~ s/000000000//g;
		$CatID =~ s/00000000//g;
		$CatID =~ s/0000000//g;

		##offset positive start
		$CatID--; 
	

		$TopDivName = "divFold" . "$CatID";
		$toggleNum = "$CatID";
		$imageName = "imgFold" . "$CatID";
		print "		<div id=\"$TopDivName\" class=\"clFold\"><a href=\"#\" onclick=\"foldmenu($toggleNum); return false\" class=\"clFoldLinks\" onfocus=\"if(this.blur)this.blur()\"><img src=\"images/ovallarge_off.gif\" name=\"$imageName\" width=\"40\" height=\"12\" border=\"0\"><img src=\"images/spacer.gif\" width=\"5\" height=\"12\" border=\"0\">$CatName</a><br>\n";
		$CountMySubs=0;






########### if multiple children present
			if ($CatConfig =~ "-----") {
				foreach (@splitConfig) { shift(@splitConfig); }
				@splitConfig = split(/-----/,$CatConfig);
				$unSub = "";
				foreach $unSub (@splitConfig) {
					$childSub1 = "divFoldSub" . $CatID . "_" . $CountMySubs;

					$imageSub1 = "imgFold" . $CatID . "Sub" . $CountMySubs;

					foreach (@splitSub) { shift(@splitSub); }
					@splitSub = split(/:::::/,$unSub);
					$myName = "$splitSub[0]";
					print "			<div id=\"$childSub1\" class=\"clFoldSub\"><a name=\"$CatID\"></a><a href=\"#$CatID\" onclick=\"subfoldmenu($CatID,$CountMySubs); return false\" class=\"clSubLinks\" onfocus=\"if(this.blur)this.blur()\"><img src=\"images/ovalsmall_off.gif\" name=\"$imageSub1\" width=\"22\" height=\"12\" border=\"0\"><img src=\"images/spacer.gif\" width=\"5\" height=\"12\" border=\"0\">$myName</a><br>\n";

					foreach (@allMySubs) { shift(@allMySubs); }
					if ($splitSub[1] =~ ",") {
						@allMySubs = split(/, /,$splitSub[1]);
					}
					else { push(@allMySubs,"$splitSub[1]"); }


					$CountSubSub=0;
					$aSub="";
					$childSubSub1 = "divFoldSub" . $CatID . "_" . $CountMySubs . "_" . "0";
					print "				<div id=\"$childSubSub1\" class=\"clFoldSub2\">\n";
					foreach $aSub (@allMySubs) {
						## run through prod list to get prod id
						foreach $unP (@todosProductos) { 
							if ($unP =~ "$aSub") {
								@thisProduct = split(/-----/,$unP);
								$thisID = $thisProduct[0];
								$thisProductName = $thisProduct[1];
								print "				<a href=\"productos.htm?pid=$thisID\" class=\"clSubLinks2\" onfocus=\"if(this.blur)this.blur()\" style=\"spacing-top:3px;\"><img src=\"images/spacer.gif\" width=\"10\" height=\"12\" border=\"0\"><img src=\"images/menuDash.gif\" width=\"10\" height=\"12\" border=\"0\">$thisProductName</a><br>";
							}
						}
						$CountSubSub++;
					}
					print "				</div>\n";
					
					
					print "			</div>\n";
					$CountMySubs++;
				}
			}






########### elsif one child present
			elsif ($CatConfig =~ ":::::") {

			
			}

			## elsif multiple products present
			elsif ($CatConfig =~ ", ") {
			
			}


		print "		</div>\n";

	}
	$sth->finish;




	
##END LEFT MENUS

print qq~

</div>
<table border="0" width="100%" cellspacing="0" cellpadding="0" align="center">
  <tr>
    <td width="70" valign="top" align="left" style="padding-top:50px;"><nobr><img src="images/catalogTitle.gif" width="38" height="185" border="0"><img src="images/spacer.gif" width="32" height="185" border="0"></nobr></td>
    <td width="100%" align="center">
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td width="342" height="168"><img src="images/home_topleft.jpg" width="342" height="168"></td>
          <td width="225"><a href="home.html"><img src="images/home_topmid.jpg" width="225" border="0" height="168"></a></td>
          <td width="225"><img src="images/home_topRight.jpg" width="232" height="168"></td>
          <td width="100%" align="left" valign="top">&nbsp; </td>
        </tr>
      </table>
      <table class="tableBacker" width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td valign="top">
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr> 
                <td colspan="5" height="80"><img src="images/spacer.gif" width="25" height="80"></td>
              </tr>
              <tr align="center" valign="top"> 
                <td colspan="5" height="80"> 
                  <table width="100%" border="0" cellspacing="0" cellpadding="0">
                    <tr align="center" valign="top"> 
                      <td width="50%" align="right"> 
                        <table class="menuTable" border="0" cellspacing="0" cellpadding="0" bgcolor="#ECE9E9">
                          <tr> 
                            <td width="223" height="5"><img src="images/menuspliter.gif" width="223" height="5"></td>
                          </tr>
                          <tr> 
                            <td width="223"><a href="company_information.html" class="menuText"><font class="menuText">Company 
                              Info</font></a></td>
                          </tr>
                          <tr> 
                            <td width="223" height="5"><img src="images/menuspliter.gif" width="223" height="5"></td>
                          </tr>
                          <tr> 
                            <td width="223" bgcolor="#999999"><a href="products.htm" class="menuText"><font class="menuText">Products / Secure Online Ordering</font></a></td>
                          </tr>
                          <tr> 
                            <td width="223" height="5"><img src="images/menuspliter.gif" width="223" height="5"></td>
                          </tr>
                          <tr> 
                            <td width="223"><a href="policies-procedures.html" class="menuText"><font class="menuText">Company Policies & Procedures</font></a></td>
                          </tr>
                          <tr> 
                            <td width="223" height="5"><img src="images/menuspliter.gif" width="223" height="5"></td>
                          </tr>
                          <tr> 
                            <td width="223"><a href="contactform.htm" class="menuText"><font class="menuText">Request Information</font></a></td>
                          </tr>
                          <tr> 
                            <td width="223" height="5"><img src="images/menuspliter.gif" width="223" height="5"></td>
                          </tr>
                        </table>
                      </td>
                      <td width="5"><img src="images/spacer.gif" width="5" height="1"></td>
                      <td width="50%" align="left"> 
                        <table class="menuTable" border="0" cellspacing="0" cellpadding="0" bgcolor="#ECE9E9">
                          <tr> 
                            <td width="223" height="5"><img src="images/menuspliter.gif" width="223" height="5"></td>
                          </tr>
                          <tr> 
                            <td width="223"><a href="movies/multimedia.html" class="menuText"><font class="menuText">Multimedia</font></a></td>
                          </tr>
                          <tr> 
                            <td width="223" height="5"><img src="images/menuspliter.gif" width="223" height="5"></td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
              <tr align="center" valign="top">
                <td colspan="5"> 
                  <table width="100%" border="0" cellspacing="0" cellpadding="0">

				  
~;

if (!$FORM{'pid'}) {
print "
                    <tr align=\"center\" valign=\"bottom\">
                      <td colspan=\"2\" height=\"30\"><font class=\"movieTitle\"><i>Products / Secure Online Ordering</i></font></td>
                    </tr>
"
}

print qq~
                    <tr align="center" valign="top"> 
                      <td colspan="2" height="100" valign="top">




                        <table width="100%" border="0" cellspacing="0" cellpadding="0">
                          <tr> 
                            <td height="500" align="center" valign="top"><font class="mainText" style="font-size:13px;color:#8C8C8C;">
							


~;

if ($FORM{'pid'}) {




	## GET SLECTED PRODUCT
	$sth = $dbh->prepare("SELECT * FROM Products where PartNum='$FORM{'pid'}'");
	$sth->execute or die "Unable to execute query\n";
	my @row;
	while(@row = $sth->fetchrow_array) { 
		$PartNum = $row[1];
		$MFGName = $row[2];
		$MFGPN = $row[3];
		$MFGLogo = $row[4];
		$IName = $row[5];
		$Desc = $row[6];
		$Specs = $row[7];
		$LargePhoto = $row[9];
		$Warranty = $row[10];
		$Weight = $row[11];
		$Accessories = $row[12];
		$VirtualStatus = $row[13];
		$IncludedItems = $row[14];
		$RetailC = $row[18];
	}
	$sth->finish;

if ($FORM{'MoreInfo'} eq "1") {
	$EsteDesc = $Specs;
}
else {
	$EsteDesc = $Desc;
}

@noEnDesc = split(/\n/,$EsteDesc);
foreach $estedesc (@noEnDesc) {
	push(@MuaDesc,"$estedesc<br>"); 
}

$MuaDesc = "@MuaDesc";

if ($MFGName ne "" && $MFGName ne "null" && $MFGName ne "NULL" && $MFGName ne "Null") {
##	$ItemName = "$IName" . " <font style=\"font-size:10px;\"><i>by " . "$MFGName</i></font>";
	$BMFGName = "<br><br>Manufacturer Name ( <b>" . $MFGName . "</b> )";
}
else {
	$BMFGName = "";
}

$ItemName = "$IName";

$SKU = "<br><br>Online SKU ( <b>" . $PartNum . "</b> )";



if ($RetailC =~ "-----") {
	@PriceArray = split(/-----/,$RetailC);
	foreach $PA (@PriceArray) {
		if ($PA =~ ":::::") {
			@splitThisPrecio = split(/:::::/,$PA);
			$myMenuOption = "$splitThisPrecio[0]";
			$myMenuPrice = "$splitThisPrecio[1]";
			$MenuOptions = $MenuOptions . "<option value=\"$PA\">$myMenuOption, \$$myMenuPrice</option>";
		}
	}

	$myProductForm = "<select name=\"Product\" class=\"OSFSSelect\"><option value=\"BIGNULL\">Option, Price US Dollars</option>$MenuOptions</select><br><br>Qty ( <input type=\"text\" size=\"2\" name=\"Quantity\" value=\"1\" OnKeyPress=\"checkThisQuantity(this);\" class=\"OSFSInput\"> )";
}
elsif ($RetailC =~ ":::::") {
	@splitPrecio = split(/:::::/,$RetailC);
	$myOption = "$splitPrecio[0]";
	$myPrice = "$splitPrecio[1]";
	$myProductForm = "<select name=\"Product\" class=\"OSFSSelect\"><option value=\"BIGNULL\">Option, Price US Dollars</option><option value=\"$RetailC\">$myOption, \$$myPrice</option></select><br><br>Qty ( <input type=\"text\" size=\"2\" name=\"Quantity\" value=\"1\" OnKeyPress=\"checkThisQuantity(this);\" class=\"OSFSInput\"> )";
}
else {
	$myProductForm = "<select name=\"Product\" class=\"OSFSSelect\"><option value=\"BIGNULL\">Call or E-Mail for Options/Pricing</option></select>";
}
##	print "($PartNum) $ItemName by $MFGName<br><img src=\"images/products/$LargePhoto\">";


$myFormButtons = "<br><img src=\"images/spacer.gif\" width=\"1\" height=\"20\" border=\"0\"><br><nobr><input type=\"image\" onclick=\"javascript:history.go(-1);\" src=\"images/cart_goback_off.gif\" border=\"0\"><img src=\"images/spacer.gif\" width=\"30\" height=\"10\" border=\"0\"><input type=\"image\" name=\"submit\" src=\"images/cart_addtocart_off.gif\" border=\"0\"></nobr><br><img src=\"images/spacer.gif\" width=\"1\" height=\"20\" border=\"0\">";

print qq~


<script language="Javascript">

function checkThisQuantity(val) {
   	var key = window.event.keyCode;
	var leValue= val.value;
	// if Key is right submit form
	// if (key == "13") { runUCart(); }
   	// key numeric?
   	if (key > 47 && key < 58) {
		leValue = val.value;
		return; 
	}
	else {
		// discard
    	window.event.returnValue = null;
	}
}
function checkInputs() {

	var formSelector = document.ATC.Product.selectedIndex;
	var formSelected = document.ATC.Product.options[formSelector].value;



	if (formSelected == "BIGNULL") {
		alert('Please select an Option/Price for this product');
		document.ATC.Product.focus();
		return false;
	}
	else if (document.ATC.Quantity.value == "" || document.ATC.Quantity.value.length <= 0) {
		alert('Quantity cannot be blank, please type a number');
		document.ATC.Quantity.focus();
		return false;
	}
	else if (document.ATC.Quantity.value == 0) {
		alert('Quantity must be higher than Zero(0)');
		document.ATC.Quantity.focus();
		return false;
	}
	else {
		return true;
	}
}
</script>

<table width="100%" cellpadding="0" cellspacing="0" border="0">
<tr>
<td valign="top" width="100"><img src="images/spacer.gif" width="100" height="1"></td>
<td valign="top" width="100%">
<img src="images/spacer.gif" width="100" height="20" vspace="1">
<table width="100%" height="24" cellpadding="0" cellspacing="0" border="0" class="prodTitle">
	<tr>
		<td width="100%" valign="top" align="left"><nobr><font class="productTitleText"><img src="images/spacer.gif" width="50" height="1" border="0">$ItemName</font></nobr></td>
	</tr>
</table>
<table width="100%" cellpadding="0" cellspacing="0" border="0">
	<tr>
		<td valign="top"><img src="images/products/$LargePhoto" border="0" hspace="20" vspace="15"></td>
		<td width="100%" valign="top" align="left"><img src="images/spacer.gif" border="0" height="25" width="10" vspace="1"><br><font class="productDesc">$MuaDesc <font class="productInfo">$BMFGName $SKU <form name="ATC" method="post" action="eCarter.htm" onSubmit="return checkInputs()"><input type="hidden" name="pid" value="$PartNum">$myProductForm $myFormButtons</form></font></font></td>
		<td valign="top" width="25"><img src="images/spacer.gif" border="0" width="25" height="10"></td>
	</tr>
</table>
</td>
</tr>


~;


}

else {
	print "&nbsp;";
}

print qq~

							
							</font></td>
                          </tr>
                        </table>

                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">
	<tr align="center" class="bottomDasher">
    	<td height="5"><img src="images/spacer.gif" width="1" height="5" border="0"></td>
	</tr>

</table>

<table width="100%" align="center" cellpadding="0" cellspacing="0" border="0">
    <tr align="center">
		<td height="25">
			
      <table width="600" cellpadding="0" cellspacing="0" border="0" height="80">
        <tr valign="middle"> 
          <td width="150" align="right"><font class="movieText2"><a href="contactform.htm" class="movieText2" style="font-family:times new,verdana,helvetica;text-decoration:underline;letter-spacing:2px;font-size:8px;color:#999999">CONTACT US</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br><a href="productos.htm" class="movieText2" style="font-family:times new,verdana,helvetica;text-decoration:underline;letter-spacing:2px;font-size:8px;color:#999999">E-CATALOG</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br><a href="movies/multimedia.html" class="movieText2" style="font-family:times new,verdana,helvetica;text-decoration:underline;letter-spacing:2px;font-size:8px;color:#999999">MULTIMEDIA</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font></td>
          <td width="150" align="center"><img src="images/logoFlat.jpg" width="62" height="66" border="0"></td>
          <td width="300"><font class="movieText2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="font-family:times new,verdana,helvetica;letter-spacing:2px;font-size:8px;color:#999999"><b>ONE STOP FIRE SHOP</b></font><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font class="movieText2" style="font-family:times new,verdana,helvetica;letter-spacing:2px;font-size:8px;color:#999999">15729 ARTIST WAY : ADDISON, TX 75001</font><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font class="movieText2" style="font-family:times new,verdana,helvetica;letter-spacing:2px;font-size:8px;color:#999999">PHONE : 1(214)632-5825</font></font></td>
		</tr>
			</table>

		</td>
	</tr>
	<tr align="center" class="bottomDasher">
    	<td height="5"><img src="images/spacer.gif" width="1" height="5" border="0"></td>
	</tr>
    <tr align="center">
		<td height="25"><font class="movieText1" style="color:#999999"><i>- - - For state and federal government contracts <b>One Stop Fire Shop</b> qualifies as a woman owned small business - - -</i></font></td>
	</tr>
</table>
</body>
</html>
~;

	## disconnect from DB
	$dbh->disconnect; 

exit;